<!DOCTYPE html>
<html>

<head>
  <title>Profile</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

  <h2>Upload Profile Picture</h2>

  <!-- Display user avatar -->
  <img id="avatar" src="" width="120" style="border-radius: 50%;" />

  <br><br>

  <!-- File input -->
  <input type="file" id="profileUpload" />
  <button id="uploadBtn">Upload</button>

  <p id="status"></p>

  <script>
    // YOUR SUPABASE KEYS HERE -----------------
    const supabase = supabase.createClient(
      "https://vjhtwuuoqrcakxncngpr.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqaHR3dXVvcXJjYWt4bmNuZ3ByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4MzU2MDgsImV4cCI6MjA3NzQxMTYwOH0.CGrAODgW7W4g_RrVrLdAsnZam6bxYKVN4PuH1gjFDq8"
    );
    //-----------------------------------------

    // Fake logged in user example — replace later with real auth
    const user = { id: "example-user-id" };

    // Load current avatar on page open
    async function loadAvatar() {
      const { data } = await supabase
        .from("users")
        .select("avatar_url")
        .eq("id", user.id)
        .single();

      if (data?.avatar_url) {
        document.getElementById("avatar").src = data.avatar_url;
      }
    }

    loadAvatar();


    // Upload button click
    document.getElementById("uploadBtn").onclick = async () => {
      const file = document.getElementById('profileUpload').files[0];

      if (!file) {
        alert("Pick a file first!");
        return;
      }

      document.getElementById("status").innerText = "Uploading...";

      const filePath = `profiles/${crypto.randomUUID()}`;

      // Upload file
      const { data, error } = await supabase.storage
        .from('odorp-files')
        .upload(filePath, file);

      if (error) {
        alert("Upload error: " + error.message);
        return;
      }

      // Get public URL
      const { data: urlData } = supabase.storage
        .from('odorp-files')
        .getPublicUrl(data.path);

      // Save URL to user table
      await supabase
        .from("users")
        .update({ avatar_url: urlData.publicUrl })
        .eq("id", user.id);

      document.getElementById("avatar").src = urlData.publicUrl;
      document.getElementById("status").innerText = "✅ Profile photo updated!";
    };
  </script>

</body>

</html>
